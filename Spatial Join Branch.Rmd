---
title: "Spatial Join / Zone Assignment"
date: "2/27/2022"
output: html_document
---



# Objective 

The spatial join branch will house the spatial join methods necessary for assigning observation points to ten minute squares and wind lease areas from main branch. 


# Code 

Contents used have come from the "Zone Assignment" Rmd created by Bryce McMagnus using FishSET zone assignment methods. Changes have been made to reflect updated data sets and new ten minute squares shapefile.   



# Shapefiles  


```{r setup, echo=TRUE, results=FALSE}
# Set Path
here::i_am("Spatial Join Branch.Rmd")
# Install Packages if necessary and Load Libraries
PKG <- c("here","leaflet", "tidyverse", "sf")
for (p in PKG) {
  if(!require(p,character.only = TRUE)) {
    install.packages(p)
    require(p,character.only = TRUE)}
}
# Set data vintage
vintage_string<-"2022_02_16"
```


## Zone assignment
```{r data}


# overwrite 
#VTR_DMIS_merge<-final_product_lease

# Load in 10 minute squares
tenMinSqr_new <- 
  here("data",
       "external",
       "shapefiles",
       "Ten Minute Squares Cut North and Greater Atlantic") %>% 
  st_read() %>% 
  st_zm() # remove Z/M dimensions from feature

# Load in All Lease Areas 
lease <- 
  here("data",
       "external",
       "shapefiles",
       "All_Lease_Areas_Shapefile") %>% 
  st_read() %>% 
  st_zm()

```


## Zone assignment

This is the approach to assign observations to zones.
```{r zone assign}
# create sf version of data, convert to WGS84
# crs <- st_crs(lease) # using crs from ten minute squares didn't change results
# 4326 is shorthand for WGS84 (https://epsg.io/4326)
crs <- 4326

scallop_sf <- 
  st_as_sf(x = VTR_DMIS_merge, coords = c("DDLON", "DDLAT"), 
           crs = crs)

# convert Squares to WGS84 
lease <- st_transform(lease, crs = st_crs(scallop_sf))

# same results as st_within
inter <- sf::st_intersects(scallop_sf, lease)

inter_save <- inter 
 
 if (any(lengths(inter) > 1)) { # if more than one zone intersects, assign to closest zone
  
  dub <- which(lengths(inter) > 1)
  inter[dub] <- st_nearest_feature(scallop_sf[dub,], lease)
 }

# Add ZoneID column to data
pts <- as.data.frame(as.numeric(inter))
colnames(pts) <- "col.id"
scallop_sf$lease <- lease$NAME[pts$col.id]
scallop_sf$lease <- lease$NAME[as.numeric(inter)]
```

